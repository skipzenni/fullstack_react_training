# Lesson 9

## Set Jwt Token

`cd server`
intal the package `npm i jsonwebtoken`
then go to routes/Users.js

```javascript
const express = require('express');
const router = express.Router();
const { Users } = require("../models");
const bcrypt = require("bcrypt");
// start
const {sign} = require('jsonwebtoken');
// end

router.post("/", async (req, res) => {
    const {username, password} = req.body;
    bcrypt.hash(password, 10).then((hash) => {
        Users.create({username: username, password: hash});
        res.json("SUCCESS");
    })
});
router.post("/login", async (req, res) => {
    const {username, password} = req.body;

    const user = await Users.findOne({where: {username: username}});

    if(!user) {
        res.json({error: "User Doesn't Exist!"});
    }

    bcrypt.compare(password, user.password).then((match) => {
        if (!match) {
            res.json({ error: "Wrong Username And Password Conbination"});
        }
        // start
        const accessToken = sign({username: user.username, id: user.id}, 'secretkeys');
        res.json(accessToken);
        // end
    })
});

module.exports = router;
```

## Setting Logic for post data and get response jwt token back and save it in local storage

first wee nee install package bcrypt for the passwort encryption
`npm i bcrypt`

go to routes and create User.js

```javascript
const express = require('express');
const router = express.Router();
const { Users } = require("../models");
const bcrypt = require("bcrypt");

router.post("/", async (req, res) => {
    const {username, password} = req.body;
    bcrypt.hash(password, 10).then((hash) => {
        Users.create({username: username, password: hash});
        res.json("SUCCESS");
    })
});
router.post("/login", async (req, res) => {
    const {username, password} = req.body;
    const user = await Users.findOne({where: {username: username}});
    if(!user) res.json({error: "User Doesn't Exist!"});
    bcrypt.compare(password, user.password).then((match) => {
        if (!match) res.json({ error: "Wrong Username And Password Conbination"});
        res.json("You Logged In!!");
    })
});

module.exports = router;
```

Initiating the route in index.js

```javascript
const usersRouter = require("./routes/Users");
app.use("/auth", usersRouter);
```

## Create Middleware

its needed if we will use the token everywhere in frontend, now create `AuthMiddleware.js`

```javascript
  const { verify } = require("jsonwebtoken");

const validateToken = (req, res, next) => {
    const accessToken = req.header("accessToken");

    if (!accessToken) {
        return res.json({error: "User not logged in"})
    }

    try {
        const validToken = verify(accessToken, "secretkeys")
        if (validToken) {
            return next();
        }
    } catch (err) {
        return res.json({error: err});
    }
};

module.exports = {validateToken};
```

## Usage backends and frontends

for example we will place this to comment post, first we nee to set routes for commant post

go to routes/Comments.js

```javascript
// 
router.post("/", validateToken, async (req, res) => {
    const comment = req.body;
    await Comments.create(comment);
    res.json(comment);
});
```

See [Leason 9](https://lesson2.com) Preview for more details
